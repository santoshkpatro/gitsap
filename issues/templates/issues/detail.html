{% extends 'shared/project_base.html' %}
{% load humanize %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />

<style>
    .timeline {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-left: 2rem;
    }

    .timeline::before {
        content: '';
        position: absolute;
        top: 0;
        left: 16px;
        bottom: 0;
        width: 2px;
        background-color: #dee2e6;
        z-index: 0;
    }

    .timeline-entry {
        display: flex;
        align-items: center;
        /* align icon and text center */
        position: relative;
    }

    .timeline-icon {
        width: 32px;
        height: 32px;
        border: 1px solid #dee2e6;
        border-radius: 50%;
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        z-index: 1;
        margin-right: 0.75rem;
    }

    .timeline-icon i {
        width: 16px;
        height: 16px;
    }

    .timeline-body {
        display: flex;
        flex-direction: column;
    }

    .timeline-time {
        font-size: 0.875rem;
        color: #6c757d;
        margin-left: 0.4rem;
    }

    .timeline-note {
        background-color: #f8f9fa;
        padding: 0.75rem;
        margin-top: 0.4rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }

    .timeline-line {
        display: flex;
        align-items: center;
        /* ensures proper vertical centering */
    }

    .ql-toolbar.ql-snow {
        border-radius: 0.375rem 0.375rem 0 0;
        border-color: #ced4da;
        background-color: #f8f9fa;
    }

    .ql-container.ql-snow {
        border-radius: 0 0 0.375rem 0.375rem;
        border-color: #ced4da;
        font-size: 0.95rem;
    }

    #editor {
        min-height: 100px;
    }

    .ql-editor.ql-blank::before {
        font-style: normal;
        color: #6c757d;
        font-size: 0.9rem;
        left: 1rem;
    }
</style>
{% endblock styles %}

{% block content %}
<div class="container mt-2">
    <div class="timeline">

        <div class="timeline-entry" style="align-items: flex-start;">
            <div class="timeline-icon text-primary">
                <i data-lucide="file-volume-2" class="lucide"></i>
            </div>
            <div class="timeline-body">
                <div class="timeline-line">
                    <span><strong>{{ issue.author.username }}</strong> added a summary to the issue.</span>
                    <span class="timeline-time">{{ issue.created_at|naturaltime }}</span>
                </div>
                <div class="timeline-note">
                    {{ issue.summary_html|safe }}
                </div>
            </div>
        </div>

        {% for activity in activities %}
        {% if activity.activity_type == 'comment' %}
        <div class="timeline-entry" style="align-items: flex-start;">
            <div class="timeline-icon text-primary">
                <i data-lucide="message-square" class="lucide"></i>
            </div>
            <div class="timeline-body">
                <div class="timeline-line">
                    <span><strong>{{ activity.author.username }}</strong> commented.</span>
                    <span class="timeline-time">{{ activity.created_at|naturaltime }}</span>
                </div>
                <div class="timeline-note">
                    {{ activity.content_html|safe }}
                </div>
            </div>
        </div>
        {% else %}
        <div class="timeline-entry">
            <div class="timeline-icon text-primary">
                <i data-lucide="activity" class="lucide"></i>
            </div>
            <div class="timeline-line">
                <span><strong>{{ activity.author.username }}</strong> {{ activity.content_html|safe }}</span>
                <span class="timeline-time">{{ activity.created_at|naturaltime }}</span>
            </div>
        </div>
        {% endif %}
        {% endfor %}


        <div class="timeline-entry">
            <div class="timeline-icon text-primary">
                <i data-lucide="message-circle-more" class="lucide"></i>
            </div>
            <div class="timeline-editor">
                <form
                    action="{% url 'issue-comment-create' username=request.user.username project_handle=project.handle issue_number=issue.issue_number %}"
                    method="post">
                    {% csrf_token %}
                    <div id="editor"></div>
                    <textarea name="content_html" hidden></textarea>
                    <div class="mt-2 d-flex justify-content-end gap-2">
                        <a class="btn btn-light btn-sm"
                            href="{% url 'issue-close' username=request.user.username project_handle=project.handle issue_number=issue.issue_number %}">
                            <i data-lucide="x-octagon" class="me-1" style="width:16px;"></i> Close Issue
                        </a>
                        <button class="btn btn-primary btn-sm" type="submit">
                            <i data-lucide="send" class="me-1" style="width:16px;"></i> Comment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script>
    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Describe your comment...',
        modules: {
            toolbar: [
                [{ header: [1, 2, false] }],
                ['bold', 'italic', 'underline', 'code'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link', 'blockquote', 'code-block'],
                ['clean']
            ]
        }
    });

    const hidden = document.querySelector('textarea[name="content_html"]');
    window.addEventListener('DOMContentLoaded', () => {
        if (hidden.value.trim()) {
            quill.root.innerHTML = hidden.value;
        }
    });

    quill.on('text-change', function () {
        hidden.value = quill.root.innerHTML;
    });
</script>
{% endblock scripts %}